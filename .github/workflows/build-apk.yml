name: Build Android APK

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'copilot/**'
    paths:
      - 'main.py'
      - 'buildozer.spec'
      - 'ghauri/**'
      - 'requirements.txt'
      - '.github/workflows/build-apk.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'main.py'
      - 'buildozer.spec'
      - 'ghauri/**'
      - 'requirements.txt'
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            ffmpeg \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            zlib1g-dev \
            libgstreamer1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            openjdk-17-jdk \
            autoconf \
            libtool \
            libtool-bin \
            automake \
            pkg-config \
            cmake \
            ninja-build \
            ccache \
            zip \
            unzip
      
      - name: Set JAVA_HOME
        run: |
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
          echo "PATH=$JAVA_HOME/bin:$PATH" >> $GITHUB_ENV
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Cache buildozer directory
        uses: actions/cache@v4
        with:
          path: .buildozer
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade Cython==0.29.33
          pip install -r requirements.txt
      
      - name: Install Buildozer
        run: |
          pip install --upgrade buildozer
          pip install python-for-android==2024.1.21
      
      - name: Build APK with Buildozer
        run: |
          buildozer -v android debug || buildozer -v android debug
        timeout-minutes: 90
      
      - name: List build output
        if: always()
        run: |
          echo "=== Build directory contents ==="
          ls -lah bin/ || echo "No bin directory found"
          echo ""
          echo "=== APK files ==="
          find . -name "*.apk" -type f || echo "No APK files found"
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ghauri-android-apk
          path: bin/*.apk
          retention-days: 30
      
      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: buildozer-logs
          path: .buildozer/logs/
          retention-days: 7
      
      - name: Get APK info
        if: success()
        run: |
          APK_FILE=$(find bin -name "*.apk" -type f | head -1)
          if [ -n "$APK_FILE" ]; then
            echo "=== APK Information ==="
            ls -lh "$APK_FILE"
            echo ""
            echo "APK Path: $APK_FILE"
            echo "APK Size: $(du -h $APK_FILE | cut -f1)"
            echo ""
            # Save APK path for potential release
            echo "APK_PATH=$APK_FILE" >> $GITHUB_ENV
          fi
      
      - name: Comment on PR with APK info
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const apkFiles = fs.readdirSync('bin').filter(f => f.endsWith('.apk'));
            
            if (apkFiles.length > 0) {
              const apkFile = apkFiles[0];
              const stats = fs.statSync(`bin/${apkFile}`);
              const sizeMB = (stats.size / (1024 * 1024)).toFixed(2);
              
              const comment = `## âœ… APK Build Successful
              
              **APK File:** \`${apkFile}\`  
              **Size:** ${sizeMB} MB  
              **Architecture:** arm64-v8a, armeabi-v7a
              
              The APK has been built successfully and is available as a workflow artifact.
              
              ### Download
              You can download the APK from the workflow artifacts section above.
              
              ### Installation
              1. Download the APK
              2. Transfer to your Android device
              3. Enable "Install from Unknown Sources"
              4. Install the APK
              
              ðŸ“± **Fully functional** - Real SQL injection testing, no simulations.
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
