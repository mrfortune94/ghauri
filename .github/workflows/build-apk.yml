name: Build Android APK

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'copilot/**'
    paths:
      - 'main.py'
      - 'buildozer.spec'
      - 'ghauri/**'
      - 'requirements.txt'
      - '.github/workflows/build-apk.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'main.py'
      - 'buildozer.spec'
      - 'ghauri/**'
      - 'requirements.txt'
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            ffmpeg \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            zlib1g-dev \
            libgstreamer1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            openjdk-17-jdk \
            autoconf \
            libtool \
            libtool-bin \
            automake \
            pkg-config \
            cmake \
            ninja-build \
            ccache \
            zip \
            unzip \
            m4 \
            gettext
      
      - name: Set JAVA_HOME
        run: |
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
          echo "PATH=$JAVA_HOME/bin:$PATH" >> $GITHUB_ENV
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Cache buildozer directory
        uses: actions/cache@v4
        with:
          path: .buildozer
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade Cython==0.29.33
          pip install -r requirements.txt
      
      - name: Install Buildozer
        run: |
          pip install --upgrade buildozer
          pip install python-for-android
      
      - name: Install Android SDK API 33 and NDK 25b
        run: |
          echo "=== Installing Android SDK API 33 and NDK 25b ==="
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-33" "build-tools;33.0.2" "ndk;25.2.9519653"
          echo "=== Verifying Android SDK installation ==="
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list | grep -E "android-33|33.0|ndk"
          echo "=== Setting NDK path to installed version ==="
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
      
      - name: Configure Buildozer SDK paths
        run: |
          # Configure buildozer to use the system SDK and NDK
          # This prevents buildozer from downloading its own SDK
          echo "ANDROIDSDK=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROIDNDK=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
          # Also set the p4a-specific environment variables
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
          # Set APP_ prefixed variables for buildozer spec override
          echo "APP_ANDROID_SDK_PATH=$ANDROID_HOME" >> $GITHUB_ENV
          echo "APP_ANDROID_NDK_PATH=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
          
          # Verify the paths exist
          echo "=== Verifying SDK/NDK paths ==="
          echo "ANDROID_HOME: $ANDROID_HOME"
          ls -la $ANDROID_HOME/platforms/ || echo "No platforms found in system SDK"
          echo "ANDROID_NDK: $ANDROID_HOME/ndk/25.2.9519653"
          ls -la $ANDROID_HOME/ndk/25.2.9519653 || echo "NDK not found"
      
      - name: Build APK with Buildozer
        run: |
          buildozer android clean || true
          buildozer -v android debug 2>&1 | tee build.log || \
          buildozer -v android debug 2>&1 | tee build.log
        timeout-minutes: 120
        env:
          ANDROIDSDK: ${{ env.ANDROID_HOME }}
          ANDROIDNDK: ${{ env.ANDROID_HOME }}/ndk/25.2.9519653
          APP_ANDROID_SDK_PATH: ${{ env.ANDROID_HOME }}
          APP_ANDROID_NDK_PATH: ${{ env.ANDROID_HOME }}/ndk/25.2.9519653
      
      - name: Locate and copy APK files
        id: copy-apk
        run: |
          echo "=== Searching for APK files in buildozer output ==="
          find .buildozer -name "*.apk" -type f
          
          echo ""
          echo "=== Creating bin directory ==="
          mkdir -p bin
          
          echo ""
          echo "=== Copying APK files to bin/ ==="
          APK_COUNT=$(find .buildozer -name "*.apk" -type f | wc -l)
          echo "Found $APK_COUNT APK file(s)"
          
          if [ "$APK_COUNT" -eq 0 ]; then
            echo "ERROR: No APK files found after build!"
            echo "Build completed but no APK was produced."
            echo ""
            echo "=== Buildozer output directory structure ==="
            find .buildozer -type d -name "apk" 2>/dev/null || echo "No apk directories found"
            exit 1
          fi
          
          # Copy all APKs to bin/
          find .buildozer -name "*.apk" -type f -exec cp -v {} bin/ \;
          
          echo ""
          echo "=== Verifying APK files in bin/ ==="
          if ! ls bin/*.apk 1> /dev/null 2>&1; then
            echo "ERROR: APK files were not copied successfully to bin/"
            exit 1
          fi
          
          echo ""
          echo "=== APK files ready for upload ==="
          ls -lh bin/*.apk
          
          # Set output for later steps
          echo "apk-found=true" >> $GITHUB_OUTPUT
      
      - name: List build output
        if: always()
        run: |
          echo "=== Build directory contents ==="
          ls -lah bin/ || echo "No bin directory found"
          echo ""
          echo "=== APK files ==="
          find . -name "*.apk" -type f || echo "No APK files found"
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        if: steps.copy-apk.outputs.apk-found == 'true'
        with:
          name: ghauri-android-apk
          path: bin/*.apk
          retention-days: 30
      
      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: buildozer-logs
          path: build.log
          retention-days: 7
      
      - name: Get APK info
        if: steps.copy-apk.outputs.apk-found == 'true'
        run: |
          APK_FILE=$(find bin -name "*.apk" -type f | head -1)
          if [ -n "$APK_FILE" ]; then
            echo "=== APK Information ==="
            ls -lh "$APK_FILE"
            echo ""
            echo "APK Path: $APK_FILE"
            echo "APK Size: $(du -h $APK_FILE | cut -f1)"
            echo ""
            # Verify APK is not empty
            APK_SIZE=$(stat -c%s "$APK_FILE")
            if [ "$APK_SIZE" -lt 1000000 ]; then
              echo "WARNING: APK size is unusually small ($APK_SIZE bytes)"
            else
              echo "âœ… APK appears to be valid (size: $APK_SIZE bytes)"
            fi
            # Save APK path for potential release
            echo "APK_PATH=$APK_FILE" >> $GITHUB_ENV
          fi
      
      - name: Comment on PR with APK info
        if: steps.copy-apk.outputs.apk-found == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const apkFiles = fs.readdirSync('bin').filter(f => f.endsWith('.apk'));
            
            if (apkFiles.length > 0) {
              const apkFile = apkFiles[0];
              const stats = fs.statSync(`bin/${apkFile}`);
              const sizeMB = (stats.size / (1024 * 1024)).toFixed(2);
              
              const comment = `## âœ… APK Build Successful
              
              **APK File:** \`${apkFile}\`  
              **Size:** ${sizeMB} MB  
              **Architecture:** arm64-v8a, armeabi-v7a
              
              The APK has been built successfully and is available as a workflow artifact.
              
              ### Download
              You can download the APK from the workflow artifacts section above.
              
              ### Installation
              1. Download the APK
              2. Transfer to your Android device
              3. Enable "Install from Unknown Sources"
              4. Install the APK
              
              ðŸ“± **Fully functional** - Real SQL injection testing, no simulations.
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
